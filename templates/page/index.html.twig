{% extends 'base.html.twig' %}

{% block title %}Inicio - Instalabra
{% endblock %}

{% block body %}
	<!-- Botones para ti y siguiendo -->
	<div class="feed-buttons">
		<a href="{{ path('app_home', {'filter': 'foryou'}) }}" style="text-decoration:none; color:inherit; flex:1;">
			<button id="for-you" class="{{ currentFilter is defined and currentFilter == 'foryou' ? 'active' : (currentFilter is not defined ? 'active' : '') }}" style="width:100%;">Para ti</button>
		</a>
		<a href="{{ path('app_home', {'filter': 'following'}) }}" style="text-decoration:none; color:inherit; flex:1;">
			<button id="following" class="{{ currentFilter is defined and currentFilter == 'following' ? 'active' : '' }}" style="width:100%;">Siguiendo</button>
		</a>
	</div>

	<!-- Formulario de Publicación -->
	{% if app.user %}
		<div style="padding: 16px; border-bottom: 1px solid #eff3f4;">
			{{ form_start(form) }}
			{# Render fields manually or using form_row #}
			{{ form_row(form.palabra, {'attr': {'placeholder': 'Palabra', 'class': 'form-input', 'style': 'width: 100%; border: none; outline: none; font-size: 18px; font-weight: bold; margin-bottom: 5px;'}}) }}
			{{ form_row(form.definicion, {'attr': {'placeholder': 'Definición...', 'rows': 2, 'style': 'width: 100%; border: none; outline: none; font-size: 16px; resize: none; font-family: inherit;'}}) }}
			<div style="display:flex; justify-content: flex-end;">
				<button type="submit" class="publicar" style="width: auto; padding: 8px 16px; font-size: 14px;">Publicar</button>
			</div>
			{{ form_end(form) }}
		</div>
	{% endif %}

	<!-- Ranking diario (Moved from Sidebar) -->
	<div class="rank-diary box" style="margin: 16px; border: 1px solid #eff3f4; border-radius: 12px; background: #f7f9f9;">
		<h3 style="font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e1e8ed;">Tendencias del día</h3>
		<ol class="word-list" id="word-list" style="list-style: none; padding: 0; margin: 0;">
			{% for palabra in topWords %}
				<li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid #eff3f4;">
					<span class="word-name" style="font-weight: 600; font-size: 15px; color: #0f1419; min-width: 80px;">
						<a href="{{ path('palabra_show', {id: palabra.palabraEntity.id}) }}" style="color:inherit; text-decoration:none;">{{ palabra.palabraEntity.palabra }}</a>
					</span>
					<div class="vote-bar" style="flex: 1; position: relative; height: 12px; background: #e1e8ed; border-radius: 6px; overflow: hidden;">
						<div class="fill" style="width: {{ (palabra.likesCount / maxLikes * 100)|round }}%; position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, #d291ff, #b26eff); border-radius: 6px;"></div>
					</div>
					<span class="vote-number" style="font-size: 13px; font-weight: 700; color: #536471;">{{ palabra.likesCount }}</span>
				</li>
			{% else %}
				<p style="text-align: center; color: #536471; padding: 10px;">No hay tendencias hoy.</p>
			{% endfor %}
		</ol>
	</div>

	{% for palabra in palabras %}
		<section class="single_post">
			<div class="post_header">
				<div class="user_info">
					<img src="{{ palabra.usuario.fotoPerfil ? asset('uploads/perfiles/' ~ palabra.usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}" alt="Foto de {{ palabra.usuario.nombre }}">
					<span>
						<a href="{{ path('app_usuario_perfil', {id: palabra.usuario.id}) }}" style="color: inherit; text-decoration: none;">
							{{ palabra.usuario.nombre }}
						</a>
					</span>
					<small style="color: #536471; font-weight: normal; margin-left: 5px;">·
						{{ palabra.fechaCreacion|date('d M') }}</small>
				</div>
			</div>

			<p style="font-size: 18px; font-weight: 500; margin-bottom: 5px;">
				<a href="{{ path('palabra_show', {id: palabra.id}) }}" style="color: inherit; text-decoration: none;">{{ palabra.palabra }}</a>
			</p>
			<p>{{ palabra.definicion }}</p>

			<div
				class="post-actions">
				<!-- LIKE -->
				<div class="action">
					{% if app.user %}
						<form action="{{ path('palabra_like_toggle', {'id': palabra.id}) }}" method="post" style="display:inline;">
							{% set liked = false %}
							{% for v in palabra.valoraciones %}
								{% if v.likeActiva and v.usuario == app.user %}
									{% set liked = true %}
								{% endif %}
							{% endfor %}
							<button type="submit" style="background:none; border:none; cursor:pointer; padding:0;">
								<img src="{{ asset('multimedia/like.png') }}" alt="Me gusta" style="{{ liked ? 'filter: hue-rotate(150deg);' : '' }}">
							</button>
						</form>
					{% else %}
						<img src="{{ asset('multimedia/like.png') }}" alt="Me gusta">
					{% endif %}
					<span class="count">{{ palabra.valoraciones|filter(v => v.likeActiva)|length }}</span>
				</div>

				<!-- COMMENT ICON -->
				<div class="action" onclick="document.getElementById('comments-{{ palabra.id }}').scrollIntoView({behavior: 'smooth'});">
					<img src="{{ asset('multimedia/comment.png') }}" alt="Comentar">
					<span class="count">{{ palabra.comentarios|length }}</span>
				</div>

				<!-- SHARE -->
				<a href="{{ path('app_chat_share', {id: palabra.id}) }}" class="action" style="text-decoration:none; color:inherit;">
					<img src="{{ asset('multimedia/share.png') }}" alt="Compartir">
					<span class="count">0</span>
				</a>

				<!-- DELETE -->
				{% if app.user and (app.user == palabra.usuario or is_granted('ROLE_ADMIN')) %}
					<div class="action">
						<form method="post" action="{{ path('palabra_delete', {id: palabra.id}) }}" onsubmit="return confirm('¿Eliminar?');">
							<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ palabra.id) }}">
							<button type="submit" style="background:none; border:none; cursor:pointer; color: red; font-size: 18px;">&times;</button>
						</form>
					</div>
				{% endif %}
			</div>

			<!-- COMENTARIOS IN FEED -->
			<div class="comments" id="comments-{{ palabra.id }}">
				{% for comentario in palabra.comentarios|slice(0, 3) %}
					<div class="comment">
						<img src="{{ comentario.usuario.fotoPerfil ? asset('uploads/perfiles/' ~ comentario.usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}" alt="{{ comentario.usuario.email }}">
						<div class="comment-text">
							<span class="username">
								<a href="{{ path('app_usuario_perfil', {id: comentario.usuario.id}) }}" style="color:inherit; text-decoration:none;">{{ comentario.usuario.nombre }}</a>
							</span>
							<span class="message">{{ comentario.texto ?? comentario.contenido ?? '' }}</span>
						</div>
						{% if app.user and (app.user == comentario.usuario or is_granted('ROLE_ADMIN')) %}
							<form method="post" action="{{ path('comentario_delete', {id: comentario.id}) }}" onsubmit="return confirm('¿Eliminar comentario?');" style="margin-left: auto;">
								<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comentario.id) }}">
								<button type="submit" style="color:red; border:none; background:none; cursor:pointer;">&times;</button>
							</form>
						{% endif %}
					</div>
				{% else %}
					<p style="padding-left: 60px; color: #999; font-size: 13px;">Aún no hay comentarios.</p>
				{% endfor %}

				{% if palabra.comentarios|length > 3 %}
					<div style="padding-left: 60px; margin-top: 5px;">
						<a href="{{ path('palabra_show', {id: palabra.id}) }}" style="font-size: 13px; color: #d291ff;">Ver todos los comentarios...</a>
					</div>
				{% endif %}

				{# Formulario de comentario rápido opcional #}
				{% if app.user %}
					<form action="{{ path('palabra_comentar', { id: palabra.id }) }}" method="post" style="padding-left: 60px; margin-top: 10px; display:flex; gap: 5px;">
						<input type="text" name="comentario_texto" placeholder="Agrega un comentario..." required style="flex:1; border: 1px solid #ddd; border-radius: 20px; padding: 5px 10px; outline:none; font-size: 13px;">
						<button type="submit" style="background:none; border:none; color: #d291ff; font-weight:bold; cursor:pointer;">Publicar</button>
					</form>
				{% endif %}
			</div>

		</section>
	{% else %}
		<div style="padding: 20px; text-align: center; color: #536471;">
			<p>No hay publicaciones aún. ¡Sé el primero!</p>
		</div>
	{% endfor %}
{% endblock %}
