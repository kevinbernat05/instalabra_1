{% extends 'base.html.twig' %}

{% block title %}Inicio - Instalabra
{% endblock %}

{% block body %}
	<!-- Difuminacion del fondo al darle click a publicar -->
	<div id="blur" class="blur"></div>
	
	<!-- Ranking diario (Moved from Sidebar) -->
	<div class="rank-container">
		<div class="rank-diary box">
			<h3>Tendencias del día</h3>
			<ol class="word-list" id="word-list">
				{% for palabra in topWords %}
					<li>
						<span class="word-name">
							<a href="{{ path('palabra_show', {id: palabra.palabraEntity.id}) }}">{{ palabra.palabraEntity.palabra }}</a>
						</span>
						<div class="vote-bar">
							<div class="fill"></div>
						</div>
						<span class="vote-number">{{ palabra.likesCount }}</span>
					</li>
				{% else %}
					<p>No hay tendencias hoy.</p>
				{% endfor %}
			</ol>
		</div>

		<div class="rank-month box">
			<h3>Tendencias del mes</h3>
			<ol class="word-list" id="word-list">
				{% for palabra in topWords %}
					<li>
						<span class="word-name">
							<a href="{{ path('palabra_show', {id: palabra.palabraEntity.id}) }}">{{ palabra.palabraEntity.palabra }}</a>
						</span>
						<div class="vote-bar">
							<div class="fill"></div>
						</div>
						<span class="vote-number">{{ palabra.likesCount }}</span>
					</li>
				{% else %}
					<p>No hay tendencias hoy.</p>
				{% endfor %}
			</ol>
		</div>
	</div>

<!-- Botones para ti y siguiendo -->
	<div class="feed-buttons">
		<a href="{{ path('app_home', {'filter': 'foryou'}) }}">
			<button id="for-you" class="{{ currentFilter is defined and currentFilter == 'foryou' ? 'active' : (currentFilter is not defined ? 'active' : '') }}">Para ti</button>
		</a>
		<a href="{{ path('app_home', {'filter': 'following'}) }}">
			<button id="following" class="{{ currentFilter is defined and currentFilter == 'following' ? 'active' : '' }}">Siguiendo</button>
		</a>
	</div>

	<!-- Formulario de Publicación -->
	{% if app.user %}
		<div>
			{{ form_start(form) }}
			{# Render fields manually or using form_row #}
			{{ form_row(form.palabra, {'attr': {'placeholder': 'Palabra', 'class': 'form-input'}}) }}
			{{ form_row(form.definicion, {'attr': {'placeholder': 'Definición...', 'rows': 2}}) }}
			<div>
				<button type="submit" class="publicar">Publicar</button>
			</div>
			{{ form_end(form) }}
		</div>
	{% endif %}

	<!-- Ranking diario (Moved from Sidebar) -->
	<div class="rank-diary box" style="margin: 16px; border: 1px solid #eff3f4; border-radius: 12px; background: #f7f9f9;">
		<h3 style="font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e1e8ed;">Tendencias del día</h3>
		<ol class="word-list" id="word-list" style="list-style: none; padding: 0; margin: 0;">
			{% for palabra in topWords %}
				<li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid #eff3f4;">
					<span class="word-name" style="font-weight: 600; font-size: 15px; color: #0f1419; min-width: 80px;">
						<a href="{{ path('palabra_show', {id: palabra.palabraEntity.id}) }}" style="color:inherit; text-decoration:none;">{{ palabra.palabraEntity.palabra }}</a>
					</span>
					<div class="vote-bar" style="flex: 1; position: relative; height: 12px; background: #e1e8ed; border-radius: 6px; overflow: hidden;">
						<div class="fill" style="width: {{ (palabra.likesCount / maxLikes * 100)|round }}%; position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, #d291ff, #b26eff); border-radius: 6px;"></div>
					</div>
					<span class="vote-number" style="font-size: 13px; font-weight: 700; color: #536471;">{{ palabra.likesCount }}</span>
				</li>
			{% else %}
				<p style="text-align: center; color: #536471; padding: 10px;">No hay tendencias hoy.</p>
			{% endfor %}
		</ol>
	</div>


	<!--Bucle para los posts-->
	{% for palabra in palabras %}
		<section class="single_post">
			<div class="post_header">
				<div class="user_info">
					<img src="{{ palabra.usuario.fotoPerfil ? asset('uploads/perfiles/' ~ palabra.usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}" alt="Foto de {{ palabra.usuario.nombre }}">
					<span>
						<a href="{{ path('app_usuario_perfil', {id: palabra.usuario.id}) }}">
							{{ palabra.usuario.nombre }}
						</a>
					</span>
					<small>·
						{{ palabra.fechaCreacion|date('d M') }}</small>
				</div>
			</div>

			<p>
				<a href="{{ path('palabra_show', {id: palabra.id}) }}">{{ palabra.palabra }}</a>
			</p>
			<p>{{ palabra.definicion }}</p>

			<div class="post-actions">
				<!-- LIKE -->
				<div class="action">
					{% if app.user %}
						<form action="{{ path('palabra_like_toggle', {'id': palabra.id}) }}" method="post">
							{% set liked = false %}
							{% for v in palabra.valoraciones %}
								{% if v.likeActiva and v.usuario == app.user %}
									{% set liked = true %}
								{% endif %}
							{% endfor %}
							<button type="submit">
								<img src="{{ asset('multimedia/like.png') }}" alt="Me gusta">
							</button>
						</form>
					{% else %}
						<img src="{{ asset('multimedia/like.png') }}" alt="Me gusta">
					{% endif %}
					<span class="count">{{ palabra.valoraciones|filter(v => v.likeActiva)|length }}</span>
				</div>

				<!-- COMMENT ICON -->
				<div class="action" onclick="document.getElementById('comments-{{ palabra.id }}').scrollIntoView({behavior: 'smooth'});">
					<img src="{{ asset('multimedia/comment.png') }}" alt="Comentar">
					<span class="count">{{ palabra.comentarios|length }}</span>
				</div>

				<!-- SHARE -->
				<a href="{{ path('app_chat_share', {id: palabra.id}) }}" class="action">
					<img src="{{ asset('multimedia/share.png') }}" alt="Compartir">
					<span class="count">0</span>
				</a>

				<!-- DELETE -->
				{% if app.user and (app.user == palabra.usuario or is_granted('ROLE_ADMIN')) %}
					<div class="action">
						<form method="post" action="{{ path('palabra_delete', {id: palabra.id}) }}" onsubmit="return confirm('¿Eliminar?');">
							<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ palabra.id) }}">
							<button type="submit">&times;</button>
						</form>
					</div>
				{% endif %}
			</div>

			<!-- COMENTARIOS IN FEED -->
			<div class="comments" id="comments-{{ palabra.id }}">
				{% for comentario in palabra.comentarios|slice(0, 3) %}
					<div class="comment">
						<img src="{{ comentario.usuario.fotoPerfil ? asset('uploads/perfiles/' ~ comentario.usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}" alt="{{ comentario.usuario.email }}">
						<div class="comment-text">
							<span class="username">
								<a href="{{ path('app_usuario_perfil', {id: comentario.usuario.id}) }}">{{ comentario.usuario.nombre }}</a>
							</span>
							<span class="message">{{ comentario.texto ?? comentario.contenido ?? '' }}</span>
						</div>
						{% if app.user and (app.user == comentario.usuario or is_granted('ROLE_ADMIN')) %}
							<form method="post" action="{{ path('comentario_delete', {id: comentario.id}) }}" onsubmit="return confirm('¿Eliminar comentario?');" style="margin-left: auto;">
								<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comentario.id) }}">
								<button type="submit">&times;</button>
							</form>
						{% endif %}
					</div>
				{% else %}
					<p>Aún no hay comentarios.</p>
				{% endfor %}

				{% if palabra.comentarios|length > 3 %}
					<div>
						<a href="{{ path('palabra_show', {id: palabra.id}) }}">Ver todos los comentarios...</a>
					</div>
				{% endif %}

				{# Formulario de comentario rápido opcional #}
				{% if app.user %}
					<form action="{{ path('palabra_comentar', { id: palabra.id }) }}" method="post">
						<input type="text" name="comentario_texto" placeholder="Agrega un comentario..." required>
						<button type="submit">Publicar</button>
					</form>
				{% endif %}
			</div>


		</section>
	{% else %}
		<div>
			<p>No hay publicaciones aún. ¡Sé el primero!</p>
		</div>
	{% endfor %}
	<!-- Ventana que va a aparecer al darle click al botón -->
	<div id="window" class="window">
		<h2>Publicar</h2>
		<button id="close-window">Cerrar</button>
	</div>
{% endblock %}
